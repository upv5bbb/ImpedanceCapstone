%---A LaTeX template for Mechatronics ME 495 Capstone report.
\documentclass[twocolumn]{article}
\oddsidemargin=-0.35in
\topmargin=-0.75in
\headsep=0.1667in
\columnsep=0.25in
\textwidth=7.25in
\textheight=9.125in
\headheight=12pt

\usepackage{myfontstyle}			% Palatino & Euler fonts
\usepackage{graphicx}               % begin standard LaTeX macros
\usepackage{fancyhdr}               % fancy headers, see fancyhdr.pdf
\usepackage{fancyvrb}               % fancy verbatim environment, see fancyvrb.pdf
\usepackage{lastpage}               % used in the footer to specify the last page
\usepackage{amsmath}                % for log-like symbols
\usepackage{color}
\usepackage{dtklogos}
\usepackage{listings}
\newcommand{\bra}[1]{\langle #1|}
\newcommand{\ket}[1]{|#1\rangle}
\newcommand{\braket}[2]{\langle #1|#2\rangle} 

\begin{document}	%  <--- Here is where the document starts

\input{Title}

%---Executive Summary
\input{Executive_Summary}

%---Introduction
\input{Introduction}

%---The Design
\input{Design} 

%---Prototype
\input{Prototype}

%---Risk and Liability
\input{Risk}
%---Ethical Issues
\input{Ethical}
%---Impact on Society
\input{Impact_society}
%---Impact on the Environment
\input{Impact_Environment}
%---Cost and Engineering Economics
\input{Cost}
%---Codes and Standards
\input{Codes}

%---Conclusions
\input{Conclusions}

%---Bibliography
\input{Bibliography}

%---Appendices
\subsection*{Appendices{\color{red}\ *}}
\subsubsection*{ --- Drawings}
\begin{enumerate}
\item{Mechanical}
\item{Electrical (individual components and connections)}
\item{Computer Hardware}
\item{Software Descriptions (flow charts, hierarchical diagrams, etc.)}
\end{enumerate}

\subsubsection*{ --- Code}
\begin{enumerate}
\item{MATLAB analysis and design}   {\color{red}\bf{*}}
\begin{enumerate}
\item{Functional Specifications Mapping}
\begin{verbatim}
%   Functional Specifications Mapping
%   Nathan Dabling
%   Impedance Control 2016
clear all
close all
clc

%% System Requirements
M = .476;      % Mass (kg)
OS = 5;        % Percent Overshoot
B = 0;         % Bearing Damping (Ns/m)
J = 1.14e-5;   % Motor inertia (kg*m^2)
Km = .058;     % Motor Constant  (N/A)
Ka = .4;       % Current Amp Gain  (A/V)
r = .0183/2;   % Timing Pulley Radius (m)
N = 230/39;    % Gear Ratio
% Damping Ratio
zeta = abs(log((OS)/100))/...
(sqrt(pi^2+(log(OS/100))^2));    
Ts = .15;         % Settling Time (s)
wn = 4/zeta/Ts;   % Natural Freq (rad/s)
	
%% Define Plant and Kp
% Proportional Gain from PI
Kp = (2*zeta*wn*(r*(M+J*((N^2)/...
(r^2))))-B/r)/(Ka*Km*N);        
% Integral Gain
Ki = wn^2*(r*(M+J*((N^2)/(r^2))))/Ka/Km/N;          
		
%% Mapping Functional Specifications
K_ref = 5;      % Reference Stiffness   
I_limit = 4.8;  % Maximum Amp Current
% Transfer Function: Force to Motor vel
FtoVMF = tf(1,[(M+(J*N^2)/(r^2)) ...
B*(N^2)/(r^2)]); 
% Transfer Function: Err to Motor current
ERRtoI = feedback(tf([Kp*Ka Ki*Ka], ...
[1 0]),tf(Km*N,[r*(M+J*(N^2)/(r^2)) ...
B*(N^2)/(r^2)]));
l = 15;     % Resolution of mapping
% Range of mass values to be tested
M_map = linspace(.01,2,l); 
% Range of damping values to be tested
B_map = linspace(1,100,l);
F = zeros(l,l);
% Counter for Force value iterations
k_count = zeros(l,l); 
a = 1;     % Counter for force values
for j = 1:l
for i = 1:l
k = 1;
err = 1;
F_map = 1;
% Transfer Function: Force to 
% Ref velocity
FtoV_map = tf([1 0],[M_map(i)...
 B_map(j) K_ref]);
FtoVA_map = FtoV_map-FtoVMF;
% Transfer Function: Force to 
% Motor current
FtoI_map = series(FtoVA_map,ERRtoI);
while abs(err) > .1
k=k+1;
FtoI_map_info = stepinfo(F_map*FtoI_map);
% Maximum current from a step input
I_max = FtoI_map_info.Peak;
err = I_max-I_limit;
if err < 0
F_map = F_map*(1+1/k);
end
if err> 0
F_map = F_map*(1-1/k);
end 
k_count(i,j)=k;
end
F(j,i) = F_map;
a=a+1;
end
end
kavg = mean(mean(k_count))
figure
surf(M_map,B_map,F);
xlabel('Virtual Mass (kg)')
ylabel('Virtual Damping (Ns/m)')
zlabel('Force Input (N)')
colorbar
\end{verbatim}
\item{Controller Design and Simulation}
\begin{verbatim}
% Richard Chen, Nathan Dabling 
% and Fangzhong Guo 
% Capstone Design
% Week 5 Spr

clear all
close all
clc

%% System Requirements
M = 1;          % Mass
OS = 10;        % Percent Overshoot
B = .00;        % Bearing Damping
J = .001;       % Wheel and Motor inertia
Km = .058;      % Motor Constant
Ka = .79;       % Current Amp. Gain
r = .0176/2;    % Wheel Radius
c = 2*pi*r;
N = 5.9;        % Gear Ratio
vol_limit = 24;
Rmot = 4;
zeta = abs(log((OS)/100))/(sqrt(pi^2...
+(log(OS/100))^2));    % Damping Ratio
Ts = .75;           % Settling Time
wn = 4/zeta/Ts;     % Natural Frequency
%% Define Plant and Kp
plant = tf(Ka*Km*N/r,[M+J*(N^2)/...
(r^2) B/(r^2)]);
% Proportional Gain
Kp = (2*zeta*wn*(r*(M+J*((N^2)/...
(r^2))))-B/r)/(Ka*Km*N);   
% Integral Gain 
Ki = wn^2*(r*(M+J*((N^2)/...
(r^2))))/Ka/Km/N;          

%% Human Input
input_mode = input('input mode = ');
Tss = 2;
Fss = 2;
impulse_duration = 0;
if input_mode == 2
impulse_duration = ...
input('Duration of the impulse = ');
end
override_flag = 1;
%% Design Parameters
testcase = [0.6 0.6 3 3 100 ...
input('Desired Virtual Mass = '); 60 0 60 0...
 0 input('Desired Virtual Elasticity = ');
70 70 100 100 70...
input('Desired Virtual Damping = ');...
5 5 10 10 20 input('Desired Input Force = ')];
target_speed = 5;
%% Simulink
imax = 0;
vmax = 0;
tmax = 0;
rmax = 0;
figure(4),hold on
title('torque map'),xlabel('rpm'),...
ylabel('torque(N*m)')
open('Impedance_Controller_Week5')
for i = 1:length(testcase(1,:))
if i == 3
i = i+1;
end
if i ==4
i = i+1;
end
M_desired = testcase(1,i);
K_desired = testcase(2,i);
B_desired = testcase(3,i);
Fss = testcase(4,i);
sim('Impedance_Controller_Week5')
figure('units','normalized',...
'outerposition',[0 0 1 1])
subplot(3,3,1),hold on
plot(mot_spd),plot(ref_spd)
title('system speed')
legend('actual speed','reference speed')
ylabel('Speed(m/s)')
subplot(3,3,2),hold on
plot(mot_pos),plot(ref_pos)
title('system position')
legend('actual position',...
'reference position')
ylabel('Position(m)')
subplot(3,3,3),hold on
plot(mot_acc),plot(ref_acc)
title('motor acceleration') 
legend('motor acceleration',...
'reference acceleration')
ylabel('Acceleration(m/s^2)')
subplot(3,3,4)
plot(mot_fn)
title('motor net force')
ylabel('Force(N)')
subplot(3,3,5)
plot(mot_f) 
title('motor force output')
ylabel('Force(N)')
subplot(3,3,6)
plot(toq_req) 
title('motor torque')
ylabel('Torque(N*m)')
subplot(3,3,7)
plot(mot_v)
title('motor voltage')
ylabel('Voltage(V)')
subplot(3,3,8)
plot(cur_req)
title('motor current')
ylabel('Current(A)')
subplot(3,3,9)
plot(mot_rpm)
title('motor RPM')
ylabel('RPM')
suptitle(['M = ' num2str(M_desired) '...
(kg) K = 'num2str(K_desired) '(N/m) ...
B = ' num2str(B_desired)...
'(N/(m/s)) F = ' num2str(Fss) 'N'])
figure(4)
plot(abs(mot_rpm.data)
abs(toq_req.data),'.')
if (max(cur_req)>imax)
imax = max(cur_req);
end
if (max(mot_v)>vmax&&i~=4)
vmax = max(mot_v);
end
if (max(toq_req)>tmax)
tmax = max(toq_req);
end
if (max(mot_rpm)>rmax&&i~=1)
rmax = max(mot_rpm);
end
end
imax
tmax
vmax
rmax
%% Discrete Control
%---
% Set to 0 to print header 
% file in Command Window only
PrintToFile = 0; 

HeaderFileName = ...
'Users\Jeff\Documents\Capstone...
\ImpedanceCapstone\ControllerHeader.h';
%-----continuous:
%---Sampling freq for discrete filter
fs=2000;        
T=1/fs;         %---Sampling period
s = tf('s');
PI = Kp + Ki/s;
sPI = series(plant,PI);
%-----discrete equivalent:
plantd=c2d(plant,T,'tustin');
PId=c2d(PI,T,'tustin');
sPId=series(plantd,PId);

%---Biquad Cascade
% SOS is an L by 6 matrix with the 
% following structure:
%         SOS = [ b01 b11 b21  1 a11 a21  
%                 b02 b12 b22  1 a12 a22
%                 ...
%                 b0L b1L b2L  1 a1L a2L ]
%---get discrete system coefficients
[b,a]=tfdata(PId,'v');      
%---convert to biquads 
[sos,gain]=tf2sos(b,a);     
[ns,n]=size(sos);
for j=1:3                   
%---Apply the gain to the final biquad
sos(ns,j)=gain*sos(ns,j);
end

if PrintToFile
fid=fopen(HeaderFileName,'W');    
else
fid=1;   
end

%---Structure for cascade
comment=['PI controller'];
PrintToBiquadFHeaderFile(fid,...
 sos, 'myFilter', T, comment);

if fid~=1
fclose(fid);
end 
return
\end{verbatim}
\end{enumerate}
\item{C-Code} {\color{red}\bf{*}}
\end{enumerate}
\subsubsection*{ --- Major components list for prototype}
\begin{enumerate}
\item{Manufacturer}
\item{Model number}
\item{Cost}
\end{enumerate}

\newpage
\subsubsection*{Here are some \LaTeX\ examples.} 

Examine the \verb|.tex| file to see how these were implemented.

\vspace{.167in}
A figure, with a graphic inserted from a \verb|.pdf| file, with a reference to the figure in the text.
\begin{figure}[htbp]
\begin{center}
\includegraphics[width=2.75in]{ControlLoop2.pdf}
\caption{Control loop diagram}
\label{ControlLoop}
\end{center}
\end{figure}

Later on in the text: \dots We cite Figure \ref{ControlLoop} above.  Note the use of the \verb|\label{}| and \verb|\ref{}|.

Here are some numbered equations, with a reference.
\begin{equation}
T(s)=\frac{C(s)}{R(s)}=\frac{G(s)}{1+G(s)H(s)}
\label{eTF}
\end{equation}
\begin{equation}
\ket{f(x)} = \frac{1}{\sqrt{r}}\sum_{\ell=0}^{r-1}e^{2\pi i \ell/r}\ket{\hat{f}(\ell)}
\label{eFT}
\end{equation}

Elsewhere in  the text the equations \ref{eTF} and \ref{eFT} are cited. Note the use of the \verb|\label{}| and \verb|\ref{}|.

\vspace{.167in}
Here is an inline equation $f(t)=m\dot{v}(t)$. 
 
\vspace{.167in}
Some citations \cite{Bendat1971}, \cite{PhysRev.104.563}, \cite{Oppenheim1975}, and \cite{Papoulis1965}. 
 
\vspace{.167in}
A good \LaTeX\ reference is \cite{Lamport1994}.  See References.

\vspace{.167in}
The \verb|tabular| environment is tricky. 

But, it produces nice tables!

\vspace{.167in}
\begin{tabular}{|r||r@{--}l|p{1.25in}|}
\hline
\multicolumn{4}{|c|}{GG\&A Hoofed Stock}  \\  \hline  \hline
&\multicolumn{2}{c|}{Price}& \\ \cline{2-3}
\multicolumn{1}{|c||}{Year}
& \multicolumn{1}{r@{\,\vline\,}}{low}
& high & \multicolumn{1}{c|}{Comments} \\ \hline
1971 & 97 & 245 & Bad year. \\ \hline
72 & 245 &  245 & Light trading due to a heavy winter.  \\ \hline
73 & 245 & 2001 & No news was very good news this year. \\ \hline
\end{tabular}

\vspace{.5in}


\end{document}	%  <--- Here is where the document ends
